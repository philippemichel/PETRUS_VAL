---
subtitle: "Plan d'analyse statistique - V1.3"
lot: false
lof: false
eval: true
---

```{r info}
rm(list=ls())
library("baseph")
library("tidyverse")
library("boot")
library("labelled")
library("ggsci")
library("readODS")
library("gtsummary")
library("irr")
library("epiDisplay")
# sessionInfo()
```

```{r}
#| label: prepa-donnees

tt <- read_ods("datas/validation.ods", sheet = 5)
```


# Généralités

Le risque $\alpha$ retenu sera de 0,05 & la puissance de 0,8. Vu la taille de l'échantillon l'hypothèse de normalité peut être retenue.


## Taille de l'échantillon

### Concordance inter observateurs

```{r}
#| label: correct cluster

nbase <- 144
ip <- 0.75
mclus <- 48

treel <- nbase + (mclus -1) * ip
treel <- round(treel*1.1+1, 0)
tlect = round((treel/40)+1, 0)
```



Il s'agit d'une étude purement observationelle donc impossible de calculer précisément un nombre de cas nécessaires. Néanmoins en se basant sur les mesures déjà effectuées & en prenant comme test principal le \gls{icc} on peut approximer un nombre raisonnable à `r nbase` mesures. Ce calcul est valable pour un échantillon unique or on a ici un groupe de mesures par lecteur ce qui correspond à une analyse en cluster.Il faut donc appliquer un coefficient correcteur. En se basant sur un \gls{icc} à
0,75 (limite basse considérée comme acceptable & donc le cas le plus défavorable pour les calculs) &  48 mesures par lecteur on obtient `r treel` mesures nécessaires soit **un minimum de  `r tlect` lecteurs**.


### Validation de la technique suite à la formation

```{r}
mc <- mean(tt$candidat)
sc <- sd(tt$candidat)
me <-  mean(tt$experts)
se <- sd(tt$experts)
nn <- n.for.2means(
  mu1 = mc,
  mu2 = me,
  sd1 = sc,
  sd2 = se
  )
nmes <- nn$n1 + (mclus -1) * ip
nlect <- round((nmes/48)+1, 0)
```

 
On compare la mesure du candidat à la moyenne des trois experts avec comme hypothèse nulle l'absence de différence entre les deux. On utilise pour cela un test t de Student pour séries appariées. Un calcul de puissance montre qu'il faudrait 708 mesures pour montrer une différence soit **15 lecteurs** (48 mesures par lecteur) à tester.


## Données manquantes

Le décompte des données manquantes sera réalisé & présenté par un tableau ou un graphique. Les lecteurs ayant trop de données manquantes ou non utilisables (> 20 %)  ne seront pas pris en compte après validation par le promoteur. Sinon les données manquantes seront imputées (\glspl{imput} multiples, 150 itérations au maximum --- package `missMDA`[@missmda]) si considérées comme manquant de manière complètement aléatoire (`MCAR`) ou manquant de manière aléatoire (`MAR`). 


# Analyse

## Validation entre les experts

On commence par vérifier la cohérence des mesures des experts en s'assurant que la différence entre les trois mesures ne dépasse pas un millimètre. Le résultat sera présenté dans un tableau avec le nombre d'erreur par expert.  

La concordance des mesures des trois experts sera alors analysée par une \gls{icc} inter-évaluateurs (modèle à deux facteurs à effets aléatoires --- *two-way random* --- package `irr` [@irr]). Un \gls{icc} \> \num{0.75} sera considéré comme correcte.





## Qualification des intervenants

*Chaque centre réalisera 10 coupes d’échographie orbitaire avec mesure du nerf optique qui seront relues par 3 experts afin d’analyser la concordance inter-observateur*

La différence du \gls{dgno} entre les sujets sains & malades serait selon la littérature de \qty{2}{\mm}. On prend donc comme écart de mesure acceptable entre le lecteur & la moyenne des mesures des experts à \qty{1}{\mm}. Les cas de divergences supérieures seront notées en précisant s'il s'agit de résultats qui sont tous deux dans la zone *saine*, *malade* ou introduisant un doute. On considère correct un investigateur qui a au plus trois erreurs sur les quarante ou quarante-huit mesures. 

Les différences éventuelles dans les mesures seront recherchées  par un test de \textsc{Kappa-Cohen} (package `irr` [@irr]) en catégorisant les résultats en normal/pathologique avec un seuil admissible à \num{0.4} (accord modéré)[^1].

 [^1]: Le seuil a été choisi bas en raison de la faible taille des échantillons (10 ou 12 cas).

La qualification des intervenants sera présentée par une comparaison (diagramme de Bland & Altmann) entre la mesure réalisée dans les centres & la moyenne des mesures des trois experts. Puis une analyse en sensibilité/spécificité sera réalisée en prenant la mesure des expert comme gold-standard. Le \gls{icc} inter-évaluateurs (modèle à deux facteurs à effets aléatoires --- *two-way random*) sera calculé (package `irr` [@irr]). Un \gls{icc} \> \num{0.75} sera considéré comme correct.


```{r}
#| label: prepa_bland


 n <- 60
A <- (rnorm(n,20,1)*1)/15
B <- (rnorm(n,20,1.2)*1)/15
C <- (rnorm(n,20,1)*1 + rnorm(n,1,1.1) * 1)/15

zz <- tibble(A,B,C) |> 
rowwise() |> 
mutate(moy = mean(c(A,B,C))) |> 
mutate(ety = sd(c(A,B,C)))
```

```{r}
#| label: fig-ba1
#| fig-cap: titre
#| eval: false


aa <- zz |> 
  pivot_longer(c(A,B,C)) 
maa <- mean(aa$value)
saa <- sd(aa$value)*1.96
var_label(aa) <- c("Moyenne par sujet","Écart-type par sujet" ,"Examinateur","Mesure")

aa |> 
  ggplot() + 
    aes(x = moy, y = value, col = name) +
    geom_point() +
    geom_hline(yintercept = maa) +
    geom_hline(yintercept = c(maa-saa,maa +saa), linetype = 6) +
    labs(title = "Mesures par examinateur",
        subtitle = "Données fictives",
        x = "Moyennes des mesures",
        y = "Mesures",
        caption = "Pour chaque cas les trois mesures sont représentées\n par trois points de couleur différente selon l'examinateur.",
        color = "Examinateur") +
    theme_light() +
    scale_fill_jama() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      legend.title = element_text(size = 12),
      axis.title.y = element_text(
        size = 12,
        angle = 90,
        vjust = .5
      ),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
    ) 
```

```{r}
#| label: fig-ba2
#| fig-cap: Écart-type des mesures
#| eval: false

msd <- mean(zz$ety)
cib <- msd-sd(zz$ety)*1.96
cih <- msd+sd(zz$ety)*1.96

zz |> 
  ggplot() + 
    aes(x = moy, y = ety) +
    geom_point(aes(x = )) +
  geom_hline(yintercept = msd, linetype = 1) +
  geom_hline(yintercept = c(cib, cih), linetype = 5) +
      labs(title = "Différences inter examinateurs",
        subtitle = "Données fictives",
        x = "Moyennes des mesures",
        y = "Écart-type des Mesures par cas",
        caption = "",
        color = "Examinateur") +
    theme_light() +
    scale_fill_jama() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      legend.title = element_text(size = 12),
      axis.title.y = element_text(
        size = 12,
        angle = 90,
        vjust = .5
      ),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
    )


```



```{r}
#| eval: false

library("irr")
tt |> 
icc(
  model = "twoway", 
  type = "agreement", unit = "single"
  )

cht


 

```

# Technique {.unnumbered}

L'analyse statistique sera réalisée avec le logiciel **R**[@rstat] & divers packages. Outre ceux cités dans le texte ou utilisera en particulier `tidyverse` [@tidy] & `baseph` [@baseph].

Un dépôt GitHub sera utilisé qui ne comprendra que le code & non les données ou résultats. Au besoin un faux tableau de données sera présenté pour permettre des tests.

<https://github.com/philippemichel/PETRUS_VAL>

\printglossaries

# Bibliographie  {.unnumbered}


